<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application Shell</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
</head>
<body style="box-sizing: content-box; margin-inline: auto; max-inline-size: 60vw; margin-top: 10vh;">
    <article>
      <h1>Counter</h1>
      <section>
        <counter-component count="5"
        ></counter-component>
      </section>
    </article>
    <article>
      <h1>Todo List</h1>
      <todo-list-component></todo-list-component>
    </article>
    <script type="module">
      import { createStore, html, ReactiveElement } from './build/cami.module.js';

      class CounterElement extends ReactiveElement {
        constructor() {
          super();
          this.observable('count', 0);
          this.computed('countSquared', () => {
            return this.count * this.count
          });
          this.effect(() => console.log(`Count: ${this.count} & Count Squared: ${this.countSquared}`));
        }

        connectedCallback() {
          super.connectedCallback();
          this.count = this.getAttribute('count');
        }

        increment() {
          this.count++;
        }

        decrement() {
          this.count--;
        }

        template() {
          return html`
            <button @click=${() => this.decrement()}>-</button>
            <span>Base: ${this.count}</span>
            <span>Squared: ${this.countSquared}</span>
            <button @click=${() => this.increment()}>+</button>
          `;
        }
      }

      customElements.define('counter-component', CounterElement);


      // Step 1: Define the initial state of our store
      const todoStore = createStore({
        todos: [],
      });

      // Step 2: Register reducers for adding and removing todo items
      todoStore.register('add', (draftStore, payload) => {
        draftStore.todos.push(payload);
      });

      todoStore.register('delete', (draftStore, payload) => {
        draftStore.todos = draftStore.todos.filter(todo => todo !== payload);
      });

      const loggingMiddleware = ({ getState, dispatch }) => next => (action, payload) => {
        console.log('Before dispatching:', getState());
        const result = next(action, payload);
        console.log('After dispatching:', getState());
        return result;
      };

      todoStore.use(loggingMiddleware);

      class TodoListElement extends ReactiveElement {
        constructor() {
          super();
          this.subscribe('todos', todoStore);
        }

        template() {
          return html`
            <input id="newTodo" type="text" />
            <button @click=${() => {
              const newTodo = document.getElementById('newTodo').value;
              this.dispatch("add", newTodo);
              document.getElementById('newTodo').value = '';
            }}>Add</button>
            <ul>
              ${this.todos.map(todo => html`
                <li>
                  ${todo}
                  <button @click=${() => this.dispatch("delete", todo)}>Delete</button> <!-- Use this.dispatch instead of todoStore.dispatch -->
                </li>
              `)}
            </ul>
          `;
        }
      }

      customElements.define('todo-list-component', TodoListElement);
    </script>
    <script src="./js/pico-theme-switch.js"></script>
</body>
</html>
