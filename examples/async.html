<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application Shell</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
</head>
<body style="box-sizing: content-box; margin-inline: auto; max-inline-size: 60vw; margin-top: 10vh;">
    <article>
      <h1>Fetch Posts with Just ReactiveElement</h1>
      <posts-component></posts-component>
    </article>
    <article>
      <h1>Fetch Posts with ReactiveElement and Store</h1>
      <posts-store-component></posts-store-component>
    </article>
    <script type="module">
      import { createStore, html, ReactiveElement } from './build/cami.module.js';

      class PostsElement extends ReactiveElement {
        constructor() {
          super();
          this.observable('posts', []);
          this.observable('loading', true);
        }

        async connectedCallback() {
          this.loading = true;
          const response = await fetch('https://jsonplaceholder.typicode.com/posts');
          const posts = await response.json();
          const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
          await sleep(500);
          this.posts = posts.slice(0, 3);
          this.loading = false;
        }

        template() {
          if (this.loading) {
            return html`<div>Loading...</div>`;
          } else {
            return html`
              <ul>
                ${this.posts.map(post => html`<li>${post.title}</li>`)}
              </ul>
            `;
          }
        }
      }

      customElements.define('posts-component', PostsElement);

      const postsStore = createStore({
        posts: [],
        loading: true,
      });

      postsStore.register('startFetchPosts', (draftStore) => {
        draftStore.loading = true;
      });

      postsStore.register('finishFetchPosts', (draftStore, payload) => {
        draftStore.posts = payload;
        draftStore.loading = false;
      });

      class PostElementWithStore extends ReactiveElement {
        constructor() {
          super();
          this.subscribe('posts', postsStore);
          this.subscribe('loading', postsStore);
        }

        async connectedCallback() {
          this.dispatch('startFetchPosts');
          const response = await fetch('https://jsonplaceholder.typicode.com/posts');
          const posts = await response.json();
          const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
          await sleep(1000);
          this.dispatch('finishFetchPosts', posts.slice(0, 5));
        }

        template() {
          if (this.loading) {
            return html`<div>Loading...</div>`;
          } else {
            return html`
              <ul>
                ${this.posts.map(post => html`<li>${post.title}</li>`)}
              </ul>
            `;
          }
        }
      }

      customElements.define('posts-store-component', PostElementWithStore);

    </script>
    <script src="./js/pico-theme-switch.js"></script>
</body>
</html>
