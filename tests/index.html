<!DOCTYPE html>
<html>
<head>
  <title>QUnit Test Suite</title>
  <link rel="stylesheet" href="https://code.jquery.com/qunit/qunit-2.20.0.css">
</head>
<body>
  <div id="qunit"></div>
  <div id="qunit-fixture"></div>
  <script src="https://code.jquery.com/qunit/qunit-2.20.0.js"></script>
  <script type="module">
    import { createStore, ReactiveElement } from './build/cami.module.js';

    // Test 1: ReactiveElement with createStore integration
    QUnit.test("ReactiveElement with createStore", function(assert) {
      const todoStore = createStore({ todos: ["initial5"] });

      class TodoListElement extends ReactiveElement {
        constructor() {
          super();
          this.setState({ todos: ["initial"] });
        }

        connectedCallback() {
          super.connectedCallback();
          todoStore.subscribe((draftState) => {
            console.log('draftState', draftState);
            this.setState({ todos: draftState.todos });
          });
        }

        template(state) {
          return this.getState().todos;
        }
      }

      todoStore.register('add', (draft, payload) => {
        console.log(payload);
        draft.todos.push(payload);
      });

      const loggingMiddleware = ({ getState, dispatch }) => next => (action, payload) => {
        console.log('Before dispatching:', getState());
        const result = next(action, payload);
        console.log('After dispatching:', getState());
        return result;
      };

      todoStore.use(loggingMiddleware);

      customElements.define('todo-element', TodoListElement);
      const todoEl = new TodoListElement();
      document.body.appendChild(todoEl);

      todoStore.dispatch('add', 'newTodo');

      assert.deepEqual(todoEl.getState().todos, ["initial5", "newTodo"], "State updated correctly from store");
    });

    // Test 2: ReactiveElement basic functionality
    QUnit.test("ReactiveElement class", function(assert) {
      class TestElement extends ReactiveElement {
        constructor() {
          super();
          this.setState({ test: "initial1" });
        }

        template(state) {
          return state.test;
        }
      }
      customElements.define('test-element', TestElement);
      const el = new TestElement();
      assert.equal(el.getState().test, "initial1", "Initial state set correctly");

      el.setState({ test: "updated" });
      assert.equal(el.getState().test, "updated", "State updated correctly");
    });

    // Test 3: createStore singleton behavior
    QUnit.test("createStore singleton behavior", function(assert) {
      const store1 = createStore({ test: "initial2" });
      const store2 = createStore({ anotherTest: "initial3" });
      assert.strictEqual(store1, store2, "createStore returns singleton instance");
    });

    // Test 4: createStore with middleware
    QUnit.test("createStore middleware functionality", function(assert) {
      const store = createStore({ test: "initial4" });
      let middlewareCalled = false;

      const testMiddleware = () => next => (action, payload) => {
        middlewareCalled = true;
        return next(action, payload);
      };

      store.use(testMiddleware);
      store.register('update', (draft, payload) => {
        draft.test = payload;
      });

      store.dispatch('update', 'new value');

      assert.ok(middlewareCalled, "Middleware was called during dispatch");
    });

  </script>
</body>
</html>
